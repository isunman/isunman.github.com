<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Sunman，太阳侠" />





  <link rel="alternate" href="/atom.xml" title="太阳侠" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="love IT, love Movie, love Love">
<meta property="og:type" content="website">
<meta property="og:title" content="太阳侠">
<meta property="og:url" content="http://isunman.com/index.html">
<meta property="og:site_name" content="太阳侠">
<meta property="og:description" content="love IT, love Movie, love Love">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="太阳侠">
<meta name="twitter:description" content="love IT, love Movie, love Love">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: undefined,
      author: '博主'
    }
  };
</script>

  <title> 太阳侠 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?edc09d74f003ef7b14a37137efc44fd4";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">太阳侠</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">我是一颗恒星</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            关于
          </a>
        </li>
      

      
      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/06/07/PHP-floating-point-calculations-must-use-the-high-precision-calculation-functions-provided-by-PHP/" itemprop="url">
                  PHP浮点数计算必须使用PHP提供的高精度计算函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-06-07T10:38:00+08:00" content="2021-06-07">
              2021-06-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、前方有坑"><a href="#一、前方有坑" class="headerlink" title="一、前方有坑"></a>一、前方有坑</h3><p>php在使用加减乘除等运算符计算浮点数的时候，经常会出现意想不到的结果，特别是关于财务数据方面的计算，给不少工程师惹了很多的麻烦。比如今天工作终于到的一个案例：</p>
<pre><code>$a = 2586;

$b = 2585.98;

var_dump($a-$b);
</code></pre><p>期望的结果是：float(0.02)</p>
<p>实际结果：</p>
<pre><code>float(0.019999999999982)
</code></pre><p>人生有坑，处处提防</p>
<h3 id="二、防坑攻略："><a href="#二、防坑攻略：" class="headerlink" title="二、防坑攻略："></a>二、防坑攻略：</h3><p>1、通过乘100的方式转化为整数加减，然后在除以100转化回来……</p>
<p>2、使用number_format转化成字符串，然后在使用（float）强转回来……</p>
<p>3、php提供了高精度计算的函数库，实际上就是为了解决这个浮点数计算问题而生的。</p>
<p>主要函数有：</p>
<p>bcadd — 将两个高精度数字相加</p>
<p>bccomp — 比较两个高精度数字，返回-1, 0, 1</p>
<p>bcdiv — 将两个高精度数字相除</p>
<p>bcmod — 求高精度数字余数</p>
<p>bcmul — 将两个高精度数字相乘</p>
<p>bcpow — 求高精度数字乘方</p>
<p>bcpowmod — 求高精度数字乘方求模，数论里非常常用</p>
<p>bcscale — 配置默认小数点位数，相当于就是Linux bc中的”scale=”</p>
<p>bcsqrt — 求高精度数字平方根</p>
<p>bcsub — 将两个高精度数字相减</p>
<p>前两种流氓的办法就不测试了，使用bcsub测试第三种两数相减的例子，</p>
<p>先看bcsub用法（来自官网）</p>
<pre><code>string bcsub ( string $left_operand , string $right_operand [, int $scale = int ] )

参数

left_operand 字符串类型的左操作数.

right_operand 字符串类型的右操作数.

scale 此可选参数用于设置结果中小数点后的小数位数。也可通过使用 bcscale() 来设置全局默认的小数位数，用于所有函数。

返回值 返回减法之后结果为字符串类型.
</code></pre><p>测试代码：</p>
<pre><code>var_dump(bcsub($a,$b,2));
</code></pre><p>结果</p>
<pre><code>0.02
</code></pre><p>其他的函数请参考PHP官方网站</p>
<h3 id="三、为啥有坑："><a href="#三、为啥有坑：" class="headerlink" title="三、为啥有坑："></a>三、为啥有坑：</h3><p>php的bug?不是，这是所有语言基本上都会遇到的问题，所以基本上大部分语言都提供了精准计算的类库或函数库。</p>
<p>要搞明白这个原因, 首先我们要知道浮点数的表示(IEEE 754):</p>
<p>浮点数, 以64位的长度(双精度)为例, 会采用1位符号位(E), 11指数位(Q), 52位尾数(M)表示(一共64位).</p>
<p>符号位：最高位表示数据的正负，0表示正数，1表示负数。</p>
<p>指数位：表示数据以2为底的幂，指数采用偏移码表示</p>
<p>尾数：表示数据小数点后的有效数字.</p>
<p>这里的关键点就在于, 小数在二进制的表示, 小数如何转化为二进制呢？</p>
<p>算法是乘以2直到没有了小数为止。这里举个例子，0.9表示成二进制数</p>
<p>0.9*2=1.8 取整数部分 1</p>
<p>0.8(1.8的小数部分)*2=1.6 取整数部分 1</p>
<p>0.6*2=1.2 取整数部分 1</p>
<p>0.2*2=0.4 取整数部分 0</p>
<p>0.4*2=0.8 取整数部分 0</p>
<p>0.8*2=1.6 取整数部分 1</p>
<p>0.6*2=1.2 取整数部分 0</p>
<p>………</p>
<p>0.9二进制表示为(从上往下): 1100100100100……</p>
<p>注意：上面的计算过程循环了，也就是说*2永远不可能消灭小数部分，这样算法将无限下去。很显然，小数的二进制表示有时是不可能精确的 。其实道理很简单，十进制系统中能不能准确表示出1/3呢？同样二进制系统也无法准确表示1/10。这也就解释了为什么浮点型减法出现了”减不尽”的精度丢失问题。</p>
<p>换句话说：我们看到十进制小数，在计算机内存储的不是一个精确的数字，也不可能精确。所以在数字加减乘除后出现意想不到的结果。</p>
<h3 id="四、防坑提示"><a href="#四、防坑提示" class="headerlink" title="四、防坑提示"></a>四、防坑提示</h3><p>基于以上原因，所以永远不要相信浮点数结果精确到了最后一位，也永远不要比较两个浮点数是否相等。如果确实需要更高的精度，应该使用任意精度数学函数或者 gmp 函数。</p>
<p>原文链接：<a href="https://www.cnblogs.com/kenshinobiy/p/10797902.html" target="_blank" rel="external">https://www.cnblogs.com/kenshinobiy/p/10797902.html</a></p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/26/two-ways-to-install-composer-on-a-linux-system/" itemprop="url">
                  Linux系统安装Composer的两种方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-04-26T00:12:00+08:00" content="2021-04-26">
              2021-04-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实际使用的系统：CentOS 6.5</p>
<h4 id="1、方法一-CURL"><a href="#1、方法一-CURL" class="headerlink" title="1、方法一 CURL"></a>1、方法一 CURL</h4><p>下载composer.phar文件</p>
<pre><code>curl -sS https://getcomposer.org/installer | php
</code></pre><p>将composer.phar移动到环境变量中并且更名为composer</p>
<pre><code>mv composer.phar  /usr/local/bin/composer
</code></pre><p>使用国内镜像</p>
<pre><code>composer config -g repo.packagist composer https://packagist.phpcomposer.com
</code></pre><h4 id="2、方法二-直接下载composer"><a href="#2、方法二-直接下载composer" class="headerlink" title="2、方法二 直接下载composer"></a>2、方法二 直接下载composer</h4><p>下载</p>
<pre><code>wget https://getcomposer.org/composer.phar
</code></pre><p>安装</p>
<pre><code>cp composer.phar /usr/local/bin/composer
chmod u+x /usr/local/bin/composer
</code></pre><p>测试</p>
<p>composer –help</p>
<h4 id="3、安装的时候用root用户，使用的时候用非root用户"><a href="#3、安装的时候用root用户，使用的时候用非root用户" class="headerlink" title="3、安装的时候用root用户，使用的时候用非root用户"></a>3、安装的时候用root用户，使用的时候用非root用户</h4><p>否则，如果使用root运行会有提示：</p>
<p>运行composer出现<code>do not run Composer as root/super user!</code></p>
<p>解决方法：</p>
<p>第1步 创建非root的新用户</p>
<pre><code>[root@centos ~]# useradd newname
[root@centos ~]# passwd  newname
</code></pre><p>第2步 切换为新用户账户</p>
<pre><code>[root@centos ~]# su newname
</code></pre><p>切换到新用户后 , 即可执行 原来的操作 , 顺利完成 composer 指令。</p>
<p>【注意】同时，需要使用root用户将 <code>/usr/local/bin/composer</code> 设置为755，否则其他用户无法执行该命令。</p>
<p>【本人亲测，使用上述方法2和步骤3成功安装了Composer 2.1-dev版。方法1未测试。】</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/25/Server-management-blood-lessons/" itemprop="url">
                  服务器管理血的教训
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-04-25T05:38:00+08:00" content="2021-04-25">
              2021-04-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>服务器管理血的教训</p>
<p>服务器管理，尤其是Linux服务器管理，必须注意以下几项原则，并做到。</p>
<h3 id="1、绝对不能随便使用rm-rf命令"><a href="#1、绝对不能随便使用rm-rf命令" class="headerlink" title="1、绝对不能随便使用rm -rf命令"></a>1、绝对不能随便使用<code>rm -rf</code>命令</h3><p>因为会递归强制删除文件，几乎都不会可恢复。【影响响程度太深】</p>
<h5 id="挽救措施："><a href="#挽救措施：" class="headerlink" title="挽救措施："></a>挽救措施：</h5><p>1、马上停止数据继续写入，将系统挂起。使用一些恢复数据的方法进行磁盘数据数据恢复操作。一般不能全部恢复；而且还会影响线上的业务的停止。</p>
<p>2、把快照的数据恢复到一个其他不是生产环境的阿里云服务器实例上，然后恢复到那个快照中的数据，再把误删除而需要的数据拷贝过来。原线上生产环境的业务不用停止。</p>
<h3 id="2、绝对不能使用-yum-update命令"><a href="#2、绝对不能使用-yum-update命令" class="headerlink" title="2、绝对不能使用 yum update命令"></a>2、绝对不能使用 <code>yum update</code>命令</h3><p>因为会升级Linux 内核，而这个升级后的内核可能会引起各种问题。【影响范围太大】</p>
<h5 id="挽救措施：-1"><a href="#挽救措施：-1" class="headerlink" title="挽救措施："></a>挽救措施：</h5><p>如果之前的系统内核还在，重启启动那个内核；<br>如果没问题的话，设置开机启动的内核为这个正常可用的内核。</p>
<h3 id="3、关键操作开始之前必须备份数据-快照"><a href="#3、关键操作开始之前必须备份数据-快照" class="headerlink" title="3、关键操作开始之前必须备份数据+快照"></a>3、关键操作开始之前必须备份数据+快照</h3><p>既不能因为精神不好产生错误的指令输入，或者粗心大意没有在意造成严重的后果；<br>又不能怕操作错误而什么都不敢做了。</p>
<p>有一个宗旨【稳定第一】【宁愿冗余，也不得丢失数据】。</p>
<p>不明确知道命令输入执行的后果的，就绝不执行。</p>
<p>——————于2021年04月25日 凌晨5：35——必须记下。</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/23/Discuz-X3.1-uses-Composer-to-install-third-party-libraries/" itemprop="url">
                  DiscuzX3.1使用Composer安装第三方类库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-04-23T17:48:00+08:00" content="2021-04-23">
              2021-04-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Discuz X3.1 是一个成熟的基于PHP开发的社区系统（广义上来讲是一个建站系统），自从被企鹅收购后悄无声息的被遗弃了，伤感啊。如今要在Discuz上加什么功能，改bug什么的只能依靠自力更生了；好在有各种开源社区，开发好的功能、类库你可以无偿的直接拿来用。</p>
<p>Composer 是一个PHP类库管理器（官网<a href="http://docs.phpcomposer.com）。Composer" target="_blank" rel="external">http://docs.phpcomposer.com）。Composer</a> 优雅的解决了PHP项目中第三方类库的安装及依赖关系。很多成熟的项目（如 Laravel ）已经把Composer作为首选的安装方式；</p>
<p>所以，在Discuz X3.1 上安装第三方类库使用Composer后，会很大提高生产力。</p>
<p>下面我来说说如何在 Discuz X3.1中使用 Composer 安装并使用第三方类库 ；</p>
<h3 id="先说安装Composer到Discuz-X3-1框架下"><a href="#先说安装Composer到Discuz-X3-1框架下" class="headerlink" title="先说安装Composer到Discuz X3.1框架下"></a>先说安装Composer到Discuz X3.1框架下</h3><h4 id="一-修改-class-core-php-source-class-class-core-php-如下"><a href="#一-修改-class-core-php-source-class-class-core-php-如下" class="headerlink" title="一. 修改 class_core.php (\source\class\class_core.php) 如下"></a>一. 修改 <code>class_core.php (\source\class\class_core.php)</code> 如下</h4><pre><code>$autoloadfile=DISCUZ_ROOT.&apos;/vendor/autoload.php&apos;;
if(!file_exists($autoloadfile)){  
    if(function_exists(&apos;spl_autoload_register&apos;)) {
        spl_autoload_register(array(&apos;core&apos;, &apos;autoload&apos;));
    } else {
           function __autoload($class) {
            return core::autoload($class);
        }
       }
}else{
    require_once  $autoloadfile;//如果存在Composer 加载器 ，则使用 ；
}
</code></pre><h4 id="二-在-Discuz-目录下，新建一个-composer-json-内容如下："><a href="#二-在-Discuz-目录下，新建一个-composer-json-内容如下：" class="headerlink" title="二. 在 Discuz 目录下，新建一个 composer.json 内容如下："></a>二. 在 Discuz 目录下，新建一个 composer.json 内容如下：</h4><pre><code>{

    &quot;require&quot;: {
         &quot;guzzlehttp/guzzle&quot;: &quot;~6.0&quot;
    },

    &quot;autoload&quot;:{
        &quot;classmap&quot;: [&quot;source/class/&quot;]
    }
}
</code></pre><h4 id="三-终端上执行命令-composer-install"><a href="#三-终端上执行命令-composer-install" class="headerlink" title="三. 终端上执行命令 composer install"></a>三. 终端上执行命令 <code>composer install</code></h4><p>看到类似这样的执行结果，表示已经安装成功了</p>
<pre><code>Loading composer repositories with package information
Updating dependencies (including require-dev)
Package operations: 10 installs, 0 updates, 0 removals
  - Installing ralouphie/getallheaders (3.0.3): Loading from cache
  - Installing psr/http-message (1.0.1): Loading from cache
  - Installing guzzlehttp/psr7 (1.8.1): Loading from cache
  - Installing guzzlehttp/promises (1.4.1): Loading from cache
  - Installing symfony/polyfill-php72 (v1.19.0): Loading from cache
  - Installing symfony/polyfill-intl-normalizer (v1.19.0): Loading from cache
  - Installing paragonie/random_compat (v2.0.20): Loading from cache
  - Installing symfony/polyfill-php70 (v1.19.0): Loading from cache
  - Installing symfony/polyfill-intl-idn (v1.19.0): Loading from cache
  - Installing guzzlehttp/guzzle (6.5.5): Loading from cache
guzzlehttp/psr7 suggests installing laminas/laminas-httphandlerrunner (Emit PSR-   7 responses)
symfony/polyfill-intl-normalizer suggests installing ext-intl (For best performa   nce)
paragonie/random_compat suggests installing ext-libsodium (Provides a modern cry   pto API that can be used to generate random bytes.)
symfony/polyfill-intl-idn suggests installing ext-intl (For best performance)
guzzlehttp/guzzle suggests installing psr/log (Required for using the Log middle   ware)
Writing lock file
Generating autoload files
4 packages you are using are looking for funding.
Use the `composer fund` command to find out more!
</code></pre><p>另外，也可以查看项目根目录下的vendor下面的文件，核验新引入的类库是否下载更新成功。</p>
<p>具体如何安装及使用 Composer 请参阅 <a href="http://docs.phpcomposer.com" target="_blank" rel="external">http://docs.phpcomposer.com</a></p>
<h3 id="再说在Discuz程序中如何使用-“composer安装”的第三方类库"><a href="#再说在Discuz程序中如何使用-“composer安装”的第三方类库" class="headerlink" title="再说在Discuz程序中如何使用 “composer安装”的第三方类库"></a>再说在Discuz程序中如何使用 “composer安装”的第三方类库</h3><p>通过Composer autoload 加载器会把这些第三方库自动加载进来，这些第三方类库程序中的类、方法(函数)等等 在Discuz 程序中你想怎么用都可以。</p>
<p>例如，以使用guzzle为例。在任何一个Discuz X3.1框架下的PHP文件中，直接使用下面代码即可。</p>
<pre><code>use GuzzleHttp\Client;

$client = new Client([
    // Base URI is used with relative requests
    &apos;base_uri&apos; =&gt; &apos;http://httpbin.org&apos;,
    // You can set any number of default request options.
    &apos;timeout&apos;  =&gt; 2.0,
]);

$response = $client-&gt;get(&apos;http://httpbin.org/get&apos;);

$code = $response-&gt;getStatusCode(); // 200
$reason = $response-&gt;getReasonPhrase(); // OK

// Check if a header exists.
if ($response-&gt;hasHeader(&apos;Content-Length&apos;)) {
    echo &quot;It exists&quot;;
}
</code></pre><p>另外，Discuz X3.2 也适用上述方法。</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/23/DiscuzX-secondary-development-directory-structure-and-operational-logic/" itemprop="url">
                  DiscuzX二次开发之目录结构和运行逻辑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-04-23T03:15:00+08:00" content="2021-04-23">
              2021-04-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-目录结构"><a href="#1-目录结构" class="headerlink" title="1.目录结构"></a>1.目录结构</h2><p>DISCUZ使用自己的框架，与现在主流的web框架不同，DISCUZ没有路由表，他的路由是由入口文件来实现的。</p>
<h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><ul>
<li>uc.php UCenter 通信文件</li>
<li>/api/addons 应用中心</li>
<li>/api/connect 通讯互联</li>
<li>/api/google Google引擎结构处理</li>
<li>/api/javascript 数据和广告的js调用</li>
<li>/api/manyou manyou应用及搜索等相关服务</li>
<li>/api/remote 远程更新</li>
<li>/api/trade 支付宝、财付通等交易接口</li>
</ul>
<h3 id="archiver-论坛Archiver静态化目录"><a href="#archiver-论坛Archiver静态化目录" class="headerlink" title="archiver (论坛Archiver静态化目录)"></a>archiver (论坛Archiver静态化目录)</h3><h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><ul>
<li>config_global.php 论坛核心参数配置文件</li>
<li>config_ucenter.php UCenter核心参数配置文件</li>
</ul>
<h3 id="data-论坛数据缓存目录"><a href="#data-论坛数据缓存目录" class="headerlink" title="data (论坛数据缓存目录)"></a>data (论坛数据缓存目录)</h3><h3 id="install-论坛安装目录-初始化运行时直接请求到此处将重新安装论坛"><a href="#install-论坛安装目录-初始化运行时直接请求到此处将重新安装论坛" class="headerlink" title="install (论坛安装目录(初始化运行时直接请求到此处将重新安装论坛))"></a>install (论坛安装目录(初始化运行时直接请求到此处将重新安装论坛))</h3><h3 id="source-程序后端功能处理目录"><a href="#source-程序后端功能处理目录" class="headerlink" title="source (程序后端功能处理目录)"></a>source (程序后端功能处理目录)</h3><ul>
<li>discuz_version.php 程序版本号文件</li>
<li>/source/admincp 后台管理</li>
<li>/source/archiver 论坛archiver静态化程序目录</li>
<li>/source/class 核心类库</li>
<li>/source/function discuzX自定义函数库</li>
<li>/source/include 程序功能组件目录</li>
<li>/source/language 程序语言包(kv结构)</li>
<li>/source/module 程序功能模块程序包</li>
<li>/source/plugins 插件扩展目录</li>
</ul>
<h3 id="static-程序资源目录-头像、图片、下载文件、js文件等等"><a href="#static-程序资源目录-头像、图片、下载文件、js文件等等" class="headerlink" title="static (程序资源目录(头像、图片、下载文件、js文件等等))"></a>static (程序资源目录(头像、图片、下载文件、js文件等等))</h3><h3 id="template-前端模板目录"><a href="#template-前端模板目录" class="headerlink" title="template (前端模板目录)"></a>template (前端模板目录)</h3><ul>
<li>/default/common 基础css文件、header、footer等公共引入文件</li>
<li>/default/collage 大学计划页面</li>
<li>/default/dige dige专区页面</li>
<li>/default/forum 首页、帖子页面</li>
<li>/default/member 会员页面</li>
<li>/default/home 家园页面</li>
<li>/default/group 群组页面</li>
<li>/default/mobile 移动端页面</li>
<li>/default/portal 文章页面</li>
<li>/default/search 搜索页面</li>
</ul>
<h3 id="uc-client-UCenter客户端"><a href="#uc-client-UCenter客户端" class="headerlink" title="uc_client (UCenter客户端)"></a>uc_client (UCenter客户端)</h3><ul>
<li>/uc_client/control UC业务处理操作类</li>
<li>/uc_client/data 缓存文件目录</li>
<li>/uc_client/lib 类库目录(包括数据库操作类,XML类,UCCODE类,邮件发送类)</li>
<li>/uc_client/model UC业务模型类</li>
</ul>
<h3 id="uc-server-UCenter服务端-后台ucenter功能实现目录"><a href="#uc-server-UCenter服务端-后台ucenter功能实现目录" class="headerlink" title="uc_server (UCenter服务端 后台ucenter功能实现目录)"></a>uc_server (UCenter服务端 后台ucenter功能实现目录)</h3><h3 id="根目录文件"><a href="#根目录文件" class="headerlink" title="根目录文件"></a>根目录文件</h3><ul>
<li>admin.php 后台入口文件</li>
<li>api.php API输出 入口文件</li>
<li>collage.php 大学计划入口文件</li>
<li>composer.json composer依赖版本记录文件</li>
<li>composer.lock composer依赖版本控制文件</li>
<li>connect.php 云平台接口文件</li>
<li>dige.php dige专区入口文件</li>
<li>forum.php 帖子信息入口文件</li>
<li>group.php 群组入口文件</li>
<li>home.php 家园入口文件</li>
<li>index.php 首页</li>
<li>member.php 用户入口文件（登录、注册、退出等）</li>
<li>misc.php 程序杂项扩展入口</li>
<li>plugin.php 插件入口文件</li>
<li>portal.php 门户入口文件</li>
<li>robots.txt 搜索引擎限制文件</li>
<li>search.php 搜索频道入口文件</li>
</ul>
<h2 id="2-运行逻辑"><a href="#2-运行逻辑" class="headerlink" title="2. 运行逻辑"></a>2. 运行逻辑</h2><p>discuz的入口文件起到了路由的作用。一个标准的discuz请求如下：</p>
<pre><code>http://localhost/home.php?mod=space&amp;uid=1&amp;do=profile
</code></pre><p>当在浏览器输入以上url时，首先执行的是跟目录下的 home.php 文件</p>
<pre><code>&lt;?php

define(&apos;APPTYPEID&apos;, 1);
define(&apos;CURSCRIPT&apos;, &apos;home&apos;);

if(!empty($_GET[&apos;mod&apos;]) &amp;&amp; ($_GET[&apos;mod&apos;] == &apos;misc&apos; || $_GET[&apos;mod&apos;] == &apos;invite&apos;)) {
    define(&apos;ALLOWGUEST&apos;, 1);
}

require_once &apos;./source/class/class_core.php&apos;;  //引入核心类文件，作用为：自动引入类规则，错误和异常处理，单例创建discuz_application类实例，引入默认函数库function.core.php
require_once &apos;./source/function/function_home.php&apos;;  //引入discuzX函数库

$discuz = C::app();  //实例化discuz_application类
$cachelist = array(&apos;magic&apos;,&apos;usergroups&apos;, &apos;diytemplatenamehome&apos;,&apos;forumlinks&apos;,&apos;identity&apos;); //加身份组缓存
$discuz-&gt;cachelist = $cachelist; //设置缓存列表
$discuz-&gt;init();  //初始化应用:数据库、系统设置、用户、session、任务、等(discuz_appication类里面)
$space = array();

$mod = getgpc(&apos;mod&apos;); //接收$_GET[&apos;mod&apos;]数据
if(!in_array($mod, array(&apos;space&apos;, &apos;spacecp&apos;, &apos;misc&apos;, &apos;magic&apos;, &apos;editor&apos;, &apos;invite&apos;, &apos;task&apos;, &apos;medal&apos;, &apos;rss&apos;, &apos;follow&apos;))) {
    $mod = &apos;space&apos;;
    $_GET[&apos;do&apos;] = &apos;home&apos;;
}

if($mod == &apos;space&apos; &amp;&amp; ((empty($_GET[&apos;do&apos;]) || $_GET[&apos;do&apos;] == &apos;index&apos;) &amp;&amp; ($_G[&apos;inajax&apos;]))) {
    $_GET[&apos;do&apos;] = &apos;profile&apos;;
}
$curmod = !empty($_G[&apos;setting&apos;][&apos;followstatus&apos;]) &amp;&amp; (empty($_GET[&apos;diy&apos;]) &amp;&amp; empty($_GET[&apos;do&apos;]) &amp;&amp; $mod == &apos;space&apos; || $_GET[&apos;do&apos;] == &apos;follow&apos;) ? &apos;follow&apos; : $mod;
define(&apos;CURMODULE&apos;, $curmod);
runhooks($_GET[&apos;do&apos;] == &apos;profile&apos; &amp;&amp; $_G[&apos;inajax&apos;] ? &apos;card&apos; : $_GET[&apos;do&apos;]);
require_once libfile(&apos;home/&apos;.$mod, &apos;module&apos;);  //根据请求时传的mod参数经由上方判断确定加载对应文件

?&gt;
</code></pre><p>注: libfile()函数在会将对应的模块字符串替换为模块的实际url。<br><code>libfile(&#39;home/&#39;.$mod, &#39;module&#39;)</code>的实际访问地址是 <code>/source/module/home/$mod.php</code></p>
<p>进入到<code>/source/module/home/home_space.php</code> 文件中 根据请求参数 uid和do的值判断具体的执行过程，有些时候会直接引入响应的程序组件完成逻辑处理(这里引入了 <code>/include/space/space_profile.php</code>)</p>
<p>在 <code>space_profile.php</code>中判断运行之后输出到模板文件<code>/template/default/home/space_profile.htm</code>中。<br>注：<code>template()</code>函数在 核心函数库 <code>function_core.php</code> 中 用于加载当前使用模板的模板文件 。根据传参此时加载了 <code>/template/default/home/space_profile.htm</code> 文件</p>
<p>在模板文件<code>space_profile.htm</code>中 可以直接使用php文件中的数据变量进行赋值渲染输出到浏览器。<br>注：template模板语法不赘述 详见 <a href="https://open.dismall.com/?ac=document&amp;page=dev_template" target="_blank" rel="external">模板语法</a></p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/04/12/PHP-to-achieve-the-length-of-Chinese-string-calculation-and-interception-without-garbled-code/" itemprop="url">
                  PHP实现中文字符串的长度计算和截取无乱码
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-04-12T15:42:00+08:00" content="2021-04-12">
              2021-04-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在我们学习PHP知识的过程中，PHP截取字符串应该是一个非常常见的字符串基础操作了，想必大家都比较熟悉这方面知识点。</p>
<p>但是有些新手朋友们可能遇到过，当待截取的字符串出现中英文混合时，计算字符串的长度，会出现不准确和截取出现乱码的情况，其实这个也是非常容易解决的。</p>
<h3 id="首先，要了解关于中英文占多少字节的问题。"><a href="#首先，要了解关于中英文占多少字节的问题。" class="headerlink" title="首先，要了解关于中英文占多少字节的问题。"></a>首先，要了解关于中英文占多少字节的问题。</h3><p>ASCII码：一个中文汉字占两个字节的空间。</p>
<p>UTF-8编码：一个中文（含繁体）等于三个字节。</p>
<p>Unicode编码：一个中文（含繁体）等于两个字节。</p>
<h3 id="其次，如果是需要计算字符串的长度，需要明确是“字符”的长度还是“字节”的长度。"><a href="#其次，如果是需要计算字符串的长度，需要明确是“字符”的长度还是“字节”的长度。" class="headerlink" title="其次，如果是需要计算字符串的长度，需要明确是“字符”的长度还是“字节”的长度。"></a>其次，如果是需要计算字符串的长度，需要明确是“字符”的长度还是“字节”的长度。</h3><p>例如，是不是中英文数字符号等1个都算1个，还是按实际占用的字节计算。<br>这个需要看具体的使用场景，需要存储导数据时，需要按字节计算实际的长度，和数据库字段的长度匹配。需要前端显示时，可能需要按字符计算。</p>
<h3 id="第三，实际处理用到的两个函数mb-substr-和mb-strlen"><a href="#第三，实际处理用到的两个函数mb-substr-和mb-strlen" class="headerlink" title="第三，实际处理用到的两个函数mb_substr()和mb_strlen()"></a>第三，实际处理用到的两个函数<code>mb_substr()</code>和<code>mb_strlen()</code></h3><p><code>mb_substr($str,$start,$len,$encoding)</code>，用于中文字符串的截取,在相应的编码页面输入相应的$encoding</p>
<p><code>mb_strlen($str,$encodding)</code>，用于获取中文字符串的长度，包含多字节的字符算成一个。</p>
<p>GBK编码截取示例</p>
<pre><code>$str = &apos;我是谁&apos;;  //gbk编码的字符串
echo mb_substr($str, 0, 1, &apos;gbk&apos;); //输出 我
</code></pre><p>utf-8编码截取示例</p>
<pre><code>$str = &apos;我abc是谁&apos;;  //utf-8编码的字符串
echo mb_substr($str, 0, 2, &apos;utf-8&apos;); //输出 我a
</code></pre><p>中英混合也完全没有问题。</p>
<p>【但是，一定要住编码需要明确指定，否则可能还是会出现乱码】</p>
<h3 id="第四，关于mb-strcut按字节来切分字符串，截取中文都不会产生半个字符的现象"><a href="#第四，关于mb-strcut按字节来切分字符串，截取中文都不会产生半个字符的现象" class="headerlink" title="第四，关于mb_strcut按字节来切分字符串，截取中文都不会产生半个字符的现象"></a>第四，关于<code>mb_strcut</code>按字节来切分字符串，截取中文都不会产生半个字符的现象</h3><p><code>substr</code>、<code>mb_substr</code>、<code>mb_strcut</code>这三个函数都用来截取字符串，所不同的是：</p>
<p><code>substr</code>是最简单的截取，无法适应中文；</p>
<p><code>mb_substr</code>是按字来切分字符串，</p>
<p>而<code>mb_strcut</code>是按字节来切分字符串，截取中文都不会产生半个字符的现象。</p>
<p>这三个函数的前三个参数完全一致，即：</p>
<p>第一个参数是操作对象</p>
<p>第二个参数是截取的起始位置</p>
<p>第三个参数是截取的数量</p>
<p><code>mb_substr</code>和<code>mb_strcut</code>还有第四个参数：第四个参数可以根据不同的字符集进行设置。</p>
<h4 id="友情提示"><a href="#友情提示" class="headerlink" title="友情提示"></a>友情提示</h4><p>使用的时候要注意php文件的编码，和网页显示时的编码。</p>
<p>使用这两个<code>mb_substr</code> 和 <code>mb_strcut</code>方法要事先知道字符串的编码，如果不知道编码，就需要判，mbstring库还提供了<code>mb_check_encoding</code>来检验字符串编码，但还不完善。</p>
<p><code>mb_check_encoding($str,$encoding)</code>;成功是返回true,失败时返回false;</p>
<p>php中文字符串的截取  其中ord($str)&gt;127(因为中文字符的acsii码的范围是128(即0x80-0xfe)-254)</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/02/18/apple-keyboard-cleaning/" itemprop="url">
                  苹果键盘的清洁
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-02-18T22:28:00+08:00" content="2021-02-18">
              2021-02-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/mac使用/" itemprop="url" rel="index">
                    <span itemprop="name">Mac使用</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>苹果键盘的清洁</p>
<p>这里说的苹果键盘是：Mac 配件——妙控键盘 - 中文 (拼音)。带数字键和不带数字键的应该是类似的逻辑，本人实际使用的是不带数字键的。</p>
<p>使用时间长了之后，键盘上面有一层脏东西，灰尘或者油污等。不带好清理，之前试过其他的方法，都不是太简单有效。今天突然试了一种新方法，简单直接有效。</p>
<p>那就是，<strong>直接使用毛巾蘸清水，拧干水分之后，直接对键盘进行擦拭</strong>。</p>
<p>下面这个图片是按这个方法擦拭之后的键盘效果。<br><img src="http://fusihan.com/isunmanfiles/MagicKeyboard.jpg" alt=""></p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/12/26/php-function-psockopen-asynchronous-call-interface-is-occasionally-useful-on-nginx/" itemprop="url">
                  PHP fsockopen 异步调用接口在nginx上偶尔实效的情况
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-12-26T12:55:00+08:00" content="2020-12-26">
              2020-12-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术日记/" itemprop="url" rel="index">
                    <span itemprop="name">技术日记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在下面这段代码里面，调用后忽略执行结果直接返回，可用于php异步执行。</p>
<pre><code>private function fsock_asy_do($get){
    $fp = fsockopen(&quot;ssl://www.xxx.com&quot;, 443, $errno, $errstr, 30);
    if (!$fp) {
        echo &quot;$errstr ($errno)&lt;br /&gt;\n&quot;;
    } else {
        stream_set_blocking($fp,0);//开启非阻塞模式
        $out = &quot;GET /&quot;.$get.&quot; HTTP/1.1\r\n&quot;;
        $out .= &quot;Host: www.xxxx.com\r\n&quot;;
        $out .= &quot;Connection: Close\r\n\r\n&quot;;

        fwrite($fp, $out);
        /*忽略执行结果
        while (!feof($fp)) {
            echo fgets($fp, 128);
        }*/
        usleep(1000);
        fclose($fp);
    }
}
</code></pre><p>在nginx服务器上有一个比较诡异的情况就是有时候无法调用异步的脚本。</p>
<p>查阅相关资料后，是nginx 499 的问题。</p>
<p>其中解决方案有以下，经过对每一个方案的验证最终得出结果：</p>
<h3 id="1、NGINX-499"><a href="#1、NGINX-499" class="headerlink" title="1、NGINX 499"></a>1、NGINX 499</h3><p>查看 NGINX access log，发现这样的请求会以 499（Client Closed Request）记录。确定问题是因为：客户端主动端口请求连接时，NGINX 不会将该请求代理给上游服务（FastCGI PHP 进程），这个时候 access log 中会以 499 记录这个请求。</p>
<p>要解决这个问题需要将 NGINX FastCGI 忽略客户端中断配置打开：</p>
<p>fastcgi_ignore_client_abort on;<br>这样无论客户端是否断开，都会将这个请求代理给上游，并且会记录上游服务处理后的返回状态。</p>
<h3 id="2、NGINX-线程原因"><a href="#2、NGINX-线程原因" class="headerlink" title="2、NGINX 线程原因"></a>2、NGINX 线程原因</h3><p>将nginx的worker_processes 由之前的auto修改为2（我的是单核服务器）</p>
<h3 id="3、NGINX-499"><a href="#3、NGINX-499" class="headerlink" title="3、NGINX 499"></a>3、NGINX 499</h3><p>nginx对499的定义是”client has closed connection”，并且在这些情况下会返回这个状态码：</p>
<p>upstream 在收到读写事件处理之前时发现连接不可用。<br>server处理请求未结束，而client提前关闭了连接。<br>upstream出错，执行next_upstream时发现连接不可用。<br>一个不安全的做法是在fclose之前，让当前的进程先睡眠一段时间；我这里设置为10毫秒，这10毫秒的延迟对我完成整个请求的影响不大，同时我也认为nginx一定能在10毫米内把请求转到fastcgi去执行。这个时间间隔很难把握，不能保证php一定有执行到。</p>
<p>这种方式并不是真正的异步，只是很取巧的强制关闭连接而不等待服务器端响应。所以在Laruence的那2篇文章中，有2个问题：</p>
<p>①PHP使用fsock不能叫做异步，只是伪异步。</p>
<p>②fwrite之后马上执行fclose，nginx会直接返回499</p>
<p>由于我的代码上面usleep为1000，初步估计是时间不够导致没发出去就close了，所以调整为20000。并进行最后测试。<br>测试2天结果显示正常，的确是usleep数值过小的问题。</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/12/18/win7-apache-suddenly-failed-to-start/" itemprop="url">
                  win7下Apache突然启动失败
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-12-18T12:45:00+08:00" content="2020-12-18">
              2020-12-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/web构建/" itemprop="url" rel="index">
                    <span itemprop="name">Web构建</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>win7下Apache突然启动失败</p>
<p>前段时间有一次重启了电脑（win7）之后，发现Apache服务并未随系统自动启动，结果在手动启动的时候也无法启动。</p>
<p>报错为：</p>
<blockquote>
<p>Windows 不能在本地计算机启动apache2.4。有关更多信息，查阅系统事件日志。如果这是非Microsoft服务，请与服务厂商联系，并参考特定服务错误代码1。</p>
</blockquote>
<p>分析后发现最大可能是80端口被占用，于是win+r 运行cmd</p>
<p>输入<code>netstat -ano</code></p>
<p>可以看到80端口被PID4占用，于是打开任务管理器-进程-查看，选择列，勾选PID</p>
<p>可以看到pid 4 的被NT kernel &amp; System 占用</p>
<p>该进程是Http.sys。它是http API的驱动组件，Http栈服务器。如果该端口被Http.sys占用，说明一些正在使用http.sys的应用程序在运行。这就是阻止Apache运行的原因，因为Http.sys占用着80端口。我们提供了一种应用程序的机制来帮助控制端口共享，但是我需要调查导致你遇到这种困难的是什么特殊应用程序。如果你能提供给我们“netsh http show servicestate”这条命令的输出结果，我就能找出是哪个应用程序在使用Http.sys。</p>
<p>你可以按照下面步骤禁用http.sys：</p>
<p>第一步： net stop http</p>
<p>第二步：Sc config http start= disabled</p>
<p>【正式操作步骤】</p>
<p>于是运行<code>net stop http</code></p>
<p>按“Y”确定</p>
<p>再运行 <code>Sc config http start= disabled</code></p>
<p>好了，现在启动Apache，发现可以正常启动了。</p>
<p>再查看一下netstat -ano</p>
<p>发现pid 4占用了445端口（不再是80端口）。
　　</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/11/22/summary-of-server-migration-issues-for-the-project/" itemprop="url">
                  项目的服务器迁移的问题的总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-11-22T21:27:00+08:00" content="2020-11-22">
              2020-11-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/服务器/" itemprop="url" rel="index">
                    <span itemprop="name">服务器</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="一、一个具体项目的服务器迁移和升级的问题总结"><a href="#一、一个具体项目的服务器迁移和升级的问题总结" class="headerlink" title="一、一个具体项目的服务器迁移和升级的问题总结"></a>一、一个具体项目的服务器迁移和升级的问题总结</h3><p>注意以下关键点：</p>
<p>1、数据库备份，不能再使用Discuz自带的备份功能，会丢失数据（不足够安全）。可以使用mysqldump直接从数据库导出sql文件，然后再目标主机导入。</p>
<p>2、数据库备份导出时，注意对emoji表情的兼容性，需要增加–default-character-set=utf8mb4参数。</p>
<p>3、新安装的项目中的字符集需要设置为utf8mb4而不是utf8，否则某些字段表情不显示（或者显示问号）。</p>
<p>4、新安装的项目不能使用MySQL总管理员账号，需要每个项目新建一个数据库，并配置一个项目数据库专用管理员，只授权管理这一个数据库。</p>
<p>5、一定要保证UCenter的应用“通信成功”，且几个项目之间必须互相隔离开（尤其是整个项目复制的，注意配置文件里的设置区分）。</p>
<p>6、迁移之前，在源主机和目标主机上都做好备份和快照。</p>
<p>7、迁移之后，测试没问题之后，及时备份和快照。</p>
<p>8、整个过程中，注意关闭站点，方式中途的数据写入。</p>
<p>9、域名的解析，可以临时域名作为过渡，最好不要让线上正式环境的域名来回更换指向IP。</p>
<p>10、域名相关的，如果使用了临时域名，尤其涉及第三方的：要么先不改；要么及时改回来。</p>
<p>11、用户资源文件的迁移，可以稍微后置。注意UCenter的用户头像文件。</p>
<p>12、迁移之后，必须要首先测试的功能：用户注册、消息推送（IP白名单）、crontab自动执行、短信发送。</p>
<p>13、注意后来添加的目录或者第三方相关目录的读写权限的设置。</p>
<p>14、本次对PHP7.2环境的支持，稍微后置。注意观察不兼容性，尤其是不常用到的接口。</p>
<p>15、注意修改php.ini的配置，支持上传大文件（建议64M），需重启生效。</p>
<p>16、注意修改nginx.conf的配置，支持上传大文件（建议64M），需重启生效。</p>
<p>17、刚迁移完后的近一段时间，注意观察是否出现异常，保持高度警惕。</p>
<p>18、【注意】Nginx服务必须设置为开机自启动，否则从阿里云控制台重启之后，Nginx服务是未启动状态。</p>
<h3 id="二、迁移服务器的通用操作流程"><a href="#二、迁移服务器的通用操作流程" class="headerlink" title="二、迁移服务器的通用操作流程"></a>二、迁移服务器的通用操作流程</h3><p>1、购买一套配置更高的阿里云ECS服务器（最好有热扩展性）。</p>
<p>2、配置相同的LNMP环境。</p>
<p>3、配置视频处理程序ffmpeg，并测试可用。</p>
<p>4、添加消息推送的白名单IP地址。（涉及多个App）</p>
<p>5、安装程序初步可用。</p>
<p>6、备份数据恢复数据。（数据库MySQL数据）</p>
<p>7、测试数据没有问题PC端（用户注册登录等）。</p>
<p>8、测试接口可用性（App和微信小程序）。</p>
<p>9、计划任务crontab的配置。（注意有脚本执行文件，可成功执行之后需删除掉原服务器的crontab的相关任务）</p>
<p>10、迁移其他非数据库MySQL数据的data资源文件（需分批处理，影响图片和视频等的显示，不影响数据处理）。</p>
<p>11、整体基本可用之后，再密切追踪至少一周，看是否有因为迁移造成的BUG或者需要修复的问题。</p>
<p>12、注意一些目录的可读权限，尤其是后来API中自定义或者第三方专用的目录。</p>
<p>13、注意服务器级别的安全组特定端口的设置。</p>
<p>14、注意SSL证书的迁移</p>
<h3 id="三、几点要求"><a href="#三、几点要求" class="headerlink" title="三、几点要求"></a>三、几点要求</h3><p>0、完美，服务器迁移几乎不影响前端访问，不需App停用。</p>
<p>1、最好，App可以平滑过渡，对服务器的迁移无感。除了迁移过程中无法使用，不影响用户的登录状态，账号和密码的可用性。</p>
<p>2、其次，让用户重新登录一次，但是账号和密码继续保持可用性。</p>
<p>3、再次，用户的账号不变，密码失效，需要重置密码才可以继续登录账号。</p>
<p>以上4种情况。至少做到1，争取做到0，绝不能出现2和3的情况。
　　</p>

          
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="isunman" />
          <p class="site-author-name" itemprop="name">isunman</p>
          <p class="site-description motion-element" itemprop="description">love IT, love Movie, love Love</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">87</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">39</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/isunman" target="_blank">
                  
                    <i class="fa fa-globe"></i> github
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/" target="_blank">知乎</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<div class="copyright" >
  
  &copy;  2011 - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">isunman</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="powered-by">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
<div class="theme-info">
<span id="busuanzi_container_site_pv">
    PV<span id="busuanzi_value_site_pv"></span> --
</span>
<span id="busuanzi_container_site_uv">
  UV<span id="busuanzi_value_site_uv"></span>
</span>
</div>


      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  
  


  

</body>
</html>
